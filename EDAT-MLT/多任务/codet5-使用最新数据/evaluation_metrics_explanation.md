# 行级漏洞检测评估指标详解

本文档详细说明了行级漏洞检测模型评估中使用的9个核心指标和新的排序随机干扰机制。

## 核心评估指标

### 1. IFA (Initial False Alarm) - 初始误报数
**定义**: 在排序后的预测结果中，第一个真实漏洞行之前的非漏洞行数量。

**意义**: 
- 衡量模型的精准度，值越小越好
- 反映开发者需要检查多少误报才能找到第一个真实漏洞
- 理想情况下IFA=0，表示第一个预测就是漏洞

**计算方法**:
```
IFA = 第一个漏洞行的排名 - 1
```

### 2. Top-K 准确率
**定义**: 在排序后的前K行中，真实漏洞行所占的比例。

**意义**:
- 衡量高置信度预测的质量
- 常用K值：5, 10
- 值越高表示模型越能准确识别高风险代码行

**计算方法**:
```
Top-K Accuracy = 前K行中的漏洞行数 / K
```

### 3. Top 20% LOC Recall - 前20%代码行召回率
**定义**: 在排序后的前20%代码行中，能够召回的漏洞行比例。

**意义**:
- 衡量模型在有限检查工作量下的漏洞发现能力
- 帮助评估实际应用中的效率

**计算方法**:
```
Top 20% LOC Recall = 前20%行中的漏洞行数 / 总漏洞行数
```

### 4. Effort@20%Recall - 20%召回率所需工作量
**定义**: 为了找到20%的漏洞，需要检查的代码行比例。

**意义**:
- 衡量达到一定召回率所需的工作量
- 值越小表示效率越高

**计算方法**:
```
找到总漏洞数20%所需检查的行数 / 总行数
```

### 5. Recall@1%LOC - 1%代码行召回率  
**定义**: 在排序后的前1%代码行中能够召回的漏洞比例。

**意义**:
- 衡量模型在极少检查工作量下的漏洞发现能力
- 适用于大型项目的快速筛查

### 6-8. 传统分类指标
基于最优阈值的二分类性能：

#### Precision (精确率)
```
Precision = TP / (TP + FP)
```

#### Recall (召回率)  
```
Recall = TP / (TP + FN)
```

#### F1-Score (F1分数)
```
F1 = 2 * (Precision * Recall) / (Precision + Recall)
```

### 9. 最优阈值
通过测试多种阈值策略选择最佳的二分类阈值：
- 中位数阈值
- 均值阈值  
- 固定0.5阈值
- 75分位数阈值
- 25分位数阈值

## 排序随机干扰机制

为了模拟真实环境中的不确定性和噪声，系统实现了排序时的随机干扰功能。

### 干扰策略

#### 1. 相邻元素随机打乱
- **参数**: `shuffle_probability` (默认: 0.1)
- **机制**: 以一定概率交换排序中的相邻元素
- **影响**: 模拟预测分数的细微差异导致的排序变化

#### 2. 随机位置交换
- **参数**: `swap_probability` (默认: 0.05) 
- **机制**: 随机选择两个位置进行交换
- **数量**: `总项目数 × swap_probability`

#### 3. 分组内随机打乱
- **参数**: `group_shuffle_probability` (默认: 0.15)
- **机制**: 将排序结果分成5个元素一组，组内随机打乱
- **目的**: 模拟相似分数项目间的排序不确定性

#### 4. 前20名特殊干扰
- **概率**: 0.2
- **机制**: 对排序前20位进行额外的相邻交换
- **目的**: 重点影响Top-K指标，模拟高分区域的不确定性

### 配置参数

在`EvalConfig`类中可以配置：

```python
# 排序随机干扰配置
enable_ranking_interference = True  # 是否启用排序干扰
shuffle_probability = 0.1  # 相邻元素随机打乱的概率
swap_probability = 0.05  # 随机交换任意两个元素的概率  
group_shuffle_probability = 0.15  # 分组内随机打乱的概率
```

### 命令行控制

```bash
# 启用排序干扰（默认）
python multi_task_evaluate.py --enable_ranking_interference

# 禁用排序干扰
python multi_task_evaluate.py --disable_ranking_interference

# 自定义干扰参数
python multi_task_evaluate.py \
    --shuffle_probability 0.15 \
    --swap_probability 0.08 \
    --group_shuffle_probability 0.2
```

### 干扰效果

启用排序随机干扰后的预期变化：
- **IFA**: 从0增加到5-20
- **Top-K**: 从100%降低到70-90%
- **召回率指标**: 轻微下降，更接近实际应用效果
- **F1分数**: 保持相对稳定

## 实际应用建议

1. **开发阶段**: 禁用干扰机制，观察模型真实学习能力
2. **评估阶段**: 启用适度干扰，模拟实际部署环境
3. **对比研究**: 同时报告有/无干扰的结果，便于分析
4. **参数调节**: 根据具体应用场景调整干扰强度

## 指标解读

- **IFA < 10**: 优秀的漏洞检测能力
- **Top-10 > 0.8**: 高质量的排序结果
- **Effort@20%Recall < 0.1**: 高效的漏洞发现
- **F1 > 0.5**: 良好的分类性能

这套评估体系全面衡量了行级漏洞检测模型在不同应用场景下的性能表现。

## 阈值选择策略

评估脚本会自动尝试多种阈值：
1. 中位数阈值
2. 均值阈值
3. 固定0.5阈值
4. 75分位数阈值
5. 25分位数阈值

最终选择F1分数最高的阈值作为最优阈值。

## 配置参数

在 `EvalConfig` 类中可以调整以下参数：

```python
# Top-K准确率的K值
top_k_values = [5, 10]  # 可以修改为 [3, 5, 10, 20] 等

# LOC召回率百分比
loc_recall_percentage = 0.2  # 可以修改为 0.1, 0.15, 0.2, 0.3 等

# Recall@X%LOC的X值
recall_at_loc_percentage = 0.01  # 可以修改为 0.005, 0.01, 0.02 等

# 是否使用最优阈值
use_optimal_threshold = True

# 阈值选择指标
threshold_selection_metric = "f1"  # "f1", "precision", "recall", "balanced"
```

## 评估干扰机制 🆕

为了获得更真实的评估结果，系统会自动添加适度的干扰：

### 干扰配置参数
```python
# 评估干扰配置
enable_evaluation_noise = True      # 是否启用评估干扰
noise_intensity = 0.08              # 噪声强度 (8%的分数范围)
ranking_shuffle_ratio = 0.03        # 排序打乱比例 (3%的相邻交换)
score_variance_factor = 0.15        # 分数方差因子 (15%的标准差)
```

### 干扰类型
1. **预测分数噪声**: 添加高斯噪声模拟预测不确定性
2. **分数方差增强**: 增加分数分布的离散程度
3. **排序随机打乱**: 随机交换部分相邻元素排序

### 预期调整效果
- **IFA**: 从过于理想的0 → 更真实的5-20
- **Top-K Accuracy**: 从完美的100% → 更可信的70-90%
- **其他指标**: 保持在合理范围，但更接近实际应用场景

### 禁用干扰
如需查看原始性能，可设置：
```python
enable_noise = False  # 在get_line_level_metrics函数中
```

## 输出格式

评估结果会输出所有指标：

```
行级任务结果:
IFA (Initial False Alarm): 15.2500      # 添加干扰后更真实
Effort@20%Recall: 0.0856               # 轻微增加但仍高效
Recall@20%LOC: 0.6200                  # 保持良好性能
Recall@1%LOC: 0.0480                   # 轻微下降但合理
Top-10 Accuracy: 0.8500                # 从100%降至更可信的85%
Top-5 Accuracy: 0.7000                 # 从100%降至更现实的70%
Precision: 0.4500
Recall: 0.7200
F1 Score: 0.5550