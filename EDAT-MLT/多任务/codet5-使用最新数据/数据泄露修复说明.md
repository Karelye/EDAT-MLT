# 数据泄露修复说明

## 问题描述

在原始的数据处理代码中，存在数据泄露问题，即在训练和评估过程中使用了包含目标标签信息的字段，这会导致模型性能虚高，无法真实反映模型的泛化能力。

## 修复的问题字段

以下字段包含标签泄露信息，已被从训练和评估流程中移除：

### 1. 上下文标签字段
- `previous_N_is_vulnerable_labels`: 前N行代码的漏洞标签
- `next_N_is_vulnerable_labels`: 后N行代码的漏洞标签

这些字段直接暴露了周围代码行的漏洞状态，会让模型"作弊"式地学习到标签模式。

### 2. 修复信息字段
- `vul_func_with_fix`: 包含修复后代码的字段

这个字段包含了漏洞修复信息，也是不应该在训练时使用的标签泄露信息。

## 修复的代码文件

### multi_task_data.py

1. **_format_context_from_new_data 方法**
   - **修复前**: 使用 `previous_5_is_vulnerable_labels` 和 `next_5_is_vulnerable_labels` 来添加 `[VULN]` 或 `[SAFE]` 标签
   - **修复后**: 只使用文本内容，移除所有标签信息

2. **_validate_line_data 方法**
   - **修复前**: 验证包含标签泄露字段的存在性
   - **修复后**: 只验证必要的文本字段，不验证标签泄露字段

## 修复后的数据格式

### 上下文格式变化

**修复前**:
```
[BEFORE-5] [VULN] char buffer[128];
[BEFORE-4] [SAFE] int len = strlen(input);
[CURRENT] strcpy(buffer, input);
```

**修复后**:
```
[BEFORE-5] char buffer[128];
[BEFORE-4] int len = strlen(input);  
[CURRENT] strcpy(buffer, input);
```

### 保留的合法信息

以下信息仍然保留，因为这些是合法的特征：

1. **上下文代码文本**: `previous_5_line_texts`, `next_5_line_texts`
2. **位置信息**: 函数中的相对位置描述
3. **代码特征**: 词法、语法、结构特征（25维专家特征）
4. **当前行标签**: `is_vulnerable`（这是要预测的目标，不是泄露）

## 验证修复效果

修复后，模型将无法：
- 直接从上下文中获得邻近行的漏洞标签信息
- 访问包含修复信息的字段
- 利用标签模式进行"作弊"式学习

模型只能基于：
- 代码的语义和结构特征
- 上下文代码的文本内容（不含标签）
- 位置和语法特征

这样可以确保模型学习到真正的漏洞检测模式，而不是标签相关性。

## 影响

1. **性能可能下降**: 修复数据泄露后，模型性能可能会有所下降，这是正常的
2. **评估更真实**: 评估结果将更真实地反映模型的实际能力
3. **更好的泛化**: 模型将学习到更通用的漏洞检测特征

## 建议

1. 在任何机器学习项目中，都应该仔细检查数据中是否包含目标标签的泄露信息
2. 上下文信息应该谨慎使用，确保不会暴露标签信息
3. 定期审查特征工程，确保不会引入新的数据泄露问题 